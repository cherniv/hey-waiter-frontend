version: 2 # use CircleCI 2.0
jobs: # a collection of steps
  build: # runs not using Workflows must have a `build` job as entry point
    working_directory: ~/mern-starter # directory where steps will run
    docker: # run the steps with Docker
      - image: circleci/node:10.13.0 # ...with this image as the primary container; this is where all `steps` will run
    #  - image: mongo:3.4.4 # and this image as the secondary service container
    steps: # a collection of executable commands
      - checkout # special step to check out source code to working directory
      
      # TESTING
      # TESTING
      # TESTING
      
      - run:
          name: update-npm
          command: 'sudo npm install -g npm@latest'
      - restore_cache: # special step to restore the dependency cache
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          key: npm-cache-v1-{{ checksum "manager/package-lock.json" }}
      - run:
          name: Install Dependencies
          command: npm ci --prefix manager
      - save_cache: # special step to save the dependency cache
          key: npm-cache-v1-{{ checksum "manager/package-lock.json" }}
          paths:
            - /home/circleci/.npm
      # - run: # run tests
      #    name: Run Tests
      #    command: npm test

      # PUBLISHING
      # PUBLISHING
      # PUBLISHING
      - run:
          name: React Scripts Build
          command: npm run build
          command: mkdir -p ./public/manager
          command: cp -a ./manager/build/. ./public/manager/
      - run:
          name: Install Firebase Tools
          command: npm install --prefix=./firebase-deploy firebase-tools
      - run:
          name: Deploy to Firebase
          command: ./firebase-deploy/node_modules/.bin/firebase deploy --only hosting --token $FIREBASE_CI_TOKEN --force